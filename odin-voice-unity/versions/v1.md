# ODIN Voice Unity SDK 1.x

Unity SDK for real-time voice chat.

> **Version Compatibility**: ODIN 1.x and 2.x are **not interoperable**. Clients using SDK 1.x cannot communicate with clients using SDK 2.x.

## Overview

The v1.x SDK uses:
- **OdinHandler** singleton pattern with `DontDestroyOnLoad`
- **MicrophoneReader** for audio capture
- **PlaybackComponent** for audio playback
- **OnCreatedMediaObject/OnDeleteMediaObject** events for media lifecycle

## Installation

### Package Manager (Recommended)

```
Window > Package Manager > + > Add package from git URL
URL: https://github.com/4Players/odin-sdk-unity.git
```

### Unity Package

1. Download `.unitypackage` from [GitHub releases](https://github.com/4Players/odin-sdk-unity/releases)
2. Double-click to import into project

> **Important**: Remove previous versions before upgrading.

## Core Components

### OdinHandler (Singleton)

Main management component - handles all ODIN functionality:

```csharp
// Access the singleton instance
OdinHandler.Instance.JoinRoom("MyRoomName");
```

**Key properties**:
- Singleton with `DontDestroyOnLoad` - survives scene changes
- Manages token generation, events, and audio pipeline
- **Placement**: Add to starting scenes like "Loading" or "Main Menu"

### OdinEditorConfig

Configuration component for:
- Sample rate settings
- Microphone selection preferences
- Basic ODIN setup parameters

### MicrophoneReader

Captures and sends audio input:

```csharp
// Control microphone transmission (push-to-talk)
AudioSender.RedirectCapturedAudio = Input.GetKey(KeyCode.V);
```

> If you place MicrophoneReader on a different GameObject than OdinHandler, ensure it also uses `DontDestroyOnLoad` to survive scene changes.

### PlaybackComponent

Manages audio playback for remote peers:
- Wraps peer audio streams as Unity AudioSources
- Enables spatial audio configuration

## Quick Start

### Security Note

> **CRITICAL**: Only embed access keys in client code for testing purposes, **NEVER** in production code. Generate room tokens on a server for production deployments. Free tier supports up to 25 concurrent users.

### Minimal Setup

```csharp
using OdinNative.Unity;

void Start()
{
    // Add listeners to events before joining room
    OdinHandler.Instance.OnMediaAdded.AddListener(OnMediaAdded);
    OdinHandler.Instance.OnMediaRemoved.AddListener(OnMediaRemoved);
    
    // Join a room
    OdinHandler.Instance.JoinRoom("MyRoomName");
}

// Peer starts sending audio
private void OnMediaAdded(object sender, MediaAddedEventArgs eventArgs)
{
    // Create playback for this peer
    Room room = sender as Room;
    if (room == null || room.Self == null || room.Self.Id == eventArgs.PeerId) return;

    // CreateOrFindGameObject is a custom method that creates a GameObject for the peer if it doesn't exist
    PlaybackComponent playback = OdinHandler.Instance.AddPlaybackComponent(
        peerContainer, room.Config.Name, eventArgs.PeerId, eventArgs.Media.Id);

    // Configure for 3D spatial audio
    playback.PlaybackSource.spatialBlend = 1.0f;
    playback.PlaybackSource.maxDistance = 10f;
}

```

## Event Handling

### Event Sequence

**Critical**: Bind event handlers BEFORE joining room.

```
1. Join Room Called
2. On Peer Joined (existing peers)  ← Events for already-connected peers
3. On Room Joined                   ← Room connection successful
4. On Peer Joined (new)             ← New peers joining after you
5. On Media Added                   ← CRITICAL: Create PlaybackComponent here
6. On Media Removed                 ← Cleanup playback
7. On Peer Left                     ← Cleanup all components
```

### Room Events

| Event        | Description                                |
|--------------|--------------------------------------------|
| OnRoomJoin   | Called before player joins a room          |
| OnRoomJoined | Called after player joins a room           |
| OnRoomLeave  | Called before player leaves a room         |
| OnRoomLeft   | Called after player leaves a room          |

### Peer Events

| Event                 | Description                           |
|-----------------------|---------------------------------------|
| OnPeerJoined          | Another player joins the room         |
| OnPeerLeft            | Another player leaves the room        |
| OnPeerUserDataChanged | User data of a peer changes           |

### Media Events

| Event                    | Description                              |
|--------------------------|------------------------------------------|
| OnCreatedMediaObject     | Peer starts sending audio                |
| OnMediaActiveStateChanged| Media state changes                      |
| OnDeleteMediaObject      | Peer stops sending audio                 |

> **Peer vs Media**: A peer can join a room without sending media (spectators). `OnPeerJoined` fires when someone connects; `OnCreatedMediaObject` fires when they start sending audio.

### Event Code Examples

```csharp
void Start()
{
    // Add listeners to events before joining room
    OdinHandler.Instance.OnMediaAdded.AddListener(OnMediaAdded);
    OdinHandler.Instance.OnMediaRemoved.AddListener(OnMediaRemoved);
    OdinHandler.Instance.OnPeerLeft.AddListener(OnPeerLeft);
    
    // Join a room
    OdinHandler.Instance.JoinRoom("MyRoomName");
}

// Peer starts sending audio
private void OnMediaAdded(object sender, MediaAddedEventArgs eventArgs)
{
    // Create playback for this peer
    Room room = sender as Room;
    if (room == null || room.Self == null || room.Self.Id == eventArgs.PeerId) return;

    // CreateOrFindGameObject is a custom method that creates a GameObject for the peer if it doesn't exist
    var peerContainer = CreateOrFindGameObject(eventArgs.PeerId, room.Config.Name);
    PlaybackComponent playback = OdinHandler.Instance.AddPlaybackComponent(
        peerContainer, room.Config.Name, eventArgs.PeerId, eventArgs.Media.Id);
}

// Peer stops sending audio
private void OnMediaRemoved(object sender, MediaRemovedEventArgs eventArgs)
{
    // Cleanup playback
}

// Peer leaves room
private void OnPeerLeft(object sender, PeerLeftEventArgs eventArgs)
{
    if (sender is Room room)
    {
        // Handle peer departure
    }
}
```

## Spatial Audio

### 2D Voice Chat (Non-Spatial)

For conferencing-style voice where everyone hears everyone equally:

```csharp
private void OnMediaAdded(object sender, MediaAddedEventArgs eventArgs)
{
    // Create playback for this peer
    Room room = sender as Room;
    if (room == null || room.Self == null || room.Self.Id == eventArgs.PeerId) return;

    PlaybackComponent playback = OdinHandler.Instance.AddPlaybackComponent(
        peerContainer, room.Config.Name, eventArgs.PeerId, eventArgs.Media.Id);
    // 2D audio - same volume for everyone
    playback.PlaybackSource.spatialBlend = 0.0f;
}
```

**Inspector Option**: Check "Playback auto creation" in OdinHandler to auto-attach all PlaybackComponents to the OdinHandler GameObject.

### 3D Voice Chat (Spatial)

For proximity-based voice where volume depends on distance:

```csharp
private void OnMediaAdded(object sender, MediaAddedEventArgs eventArgs)
{
    // Create playback for this peer
    Room room = sender as Room;
    if (room == null || room.Self == null || room.Self.Id == eventArgs.PeerId) return;

    // Find player GameObject for this peer
    GameObject playerObject = FindPlayerByPeerId(peerId);

    PlaybackComponent playback = OdinHandler.Instance.AddPlaybackComponent(
        playerObject, room.Config.Name, eventArgs.PeerId, eventArgs.Media.Id);
    // Configure 3D spatial audio
    playback.PlaybackSource.spatialBlend = 1.0f;
    playback.PlaybackSource.rolloffMode = AudioRolloffMode.Linear;
    playback.PlaybackSource.maxDistance = 10f;
    playback.PlaybackSource.minDistance = 1f;
}
```

**Inspector Option**: Check "Manual Positional Audio" in OdinHandler to manually control PlaybackComponent placement.

### Player ID Synchronization

Typical pattern for multiplayer games:

```
1. Each character has replicated PlayerId (GUID)
2. Store mapping: PlayerId → Character* in GameInstance
3. On peer join: Extract PlayerId from UserData
4. Create mapping: PeerId → Character*
5. On media added: Look up character, attach PlaybackComponent
```

## Common Patterns

### Push-to-Talk

```csharp
void Update() {
    // V key for push-to-talk
    AudioSender.RedirectCapturedAudio = Input.GetKey(KeyCode.V);
}
```

### User Data for Player Mapping

Share player identity via ODIN user data for peer-to-player mapping:

```csharp
// When joining - set user data.
UserData peerUserData = new UserData("myPlayerId");
OdinHandler.Instance.UpdateUserData(peerUserData);

// When peer joins - extract their player ID
void OnPeerJoined(string roomName, ulong peerId, byte[] userData) {
    string theirPlayerId = eventArgs.Peer.UserData.ToString();
    // Map to correct player GameObject
}
```

It's also possible to use Json to store more complex data in user data.

## Available Samples

Import from Package Manager (4Players ODIN > Samples):

| Sample                  | Description                              |
|-------------------------|------------------------------------------|
| Minimal Example         | Basic client for custom scripting        |
| Simple Room Join        | Auto-join specified room for testing     |
| Push-to-Talk Example    | Room join with PTT support               |
| Audio 3D Example        | Positional audio with AudioSource        |

## Integration Guides

- **Photon PUN**: Integration sample available
- **Mirror Networking**: Full multiplayer guide with proximity voice
- **Mirror Transport**: ODIN as network transport layer

## Testing

Use the ODIN Web Client at https://4players.app for cross-platform testing:
- Same access key as your game
- Same gateway URL and room name
- Test voice chat without multiple game instances

## Troubleshooting

See [references/troubleshooting.md](../references/troubleshooting.md) for common issues.

## Documentation Links

- Main docs: https://docs.4players.io/voice/unity/
- Guides: https://docs.4players.io/voice/unity/guides/
- API Reference: https://docs.4players.io/voice/unity/api/
- GitHub: https://github.com/4Players/odin-sdk-unity
