# ODIN Voice Unity SDK 2.x

Unity SDK for real-time voice chat with component-based, multi-room architecture.

> **Version Compatibility**: ODIN 1.x and 2.x are **not interoperable**. Clients using SDK 1.x cannot communicate with clients using SDK 2.x.

> **Pre-release Notice**: Version 2.x is currently in a pre-release testing phase. Documentation and features are subject to change.

## Overview

The v2.x SDK introduces:
- **OdinRoom** component (non-singleton) - enables multiple concurrent rooms
- **OdinPeer** and **OdinMedia** components for peer/media management
- **Room class** for low-level control with thread-safe event handling
- **Audio pipeline effects** (VAD, VolumeBoost, Mute)

### Key Changes from v1.x

| v1.x                           | v2.x                                |
|--------------------------------|-------------------------------------|
| `OdinHandler` singleton        | `OdinRoom` component (non-singleton)|
| `OdinHandler.Instance.JoinRoom()` | `odinRoom.Token = token;`        |
| Manual `AddPlaybackComponent()` | `OdinPeer.AddMediaComponent()`     |
| `OnCreatedMediaObject`         | `OnPeerJoined`, `OnMediaAdded`     |
| Room-level APM config          | Per-encoder audio pipeline effects |

## Installation

1. Request ZIP file from 4Players (beta access required)
2. Extract ZIP to local folder
3. Open Unity Package Manager (Window > Package Manager)
4. Click + button → "Add package from disk"
5. Select `package.json` from extracted folder

## API Decision Tree

```
Need voice chat?
├─ Simple 2D (non-spatial) → Use OdinRoom component with prefab
├─ Simple 3D (spatial) → Use OdinRoom + custom event handling
└─ Complex multi-room/shared connections → Use Room class (Low-Level)
```

## High-Level API: OdinRoom Component

### OdinInstance Prefab

Pre-configured prefab containing essential components. Drag into your scene from `Packages/io.fourplayers.odin/Runtime/`.

Components included:
- **OdinBanner**: Links to documentation
- **OdinRoom**: Main component for server communication
- **OdinMicrophoneReader**: Microphone capture

### OdinRoom Properties

| Property           | Description                                    |
|--------------------|------------------------------------------------|
| Gateway            | Server URL (default: ODIN hosted solution)     |
| Token              | Auth token - auto-joins when set               |
| IsJoined           | Connection status                              |
| AudioMixerGroup    | For audio effects on voice streams             |

### OdinRoom Events

| Event                    | Description                                     |
|--------------------------|-------------------------------------------------|
| OnRoomJoined             | Successfully joined (RoomJoinedEventArgs)       |
| OnPeerJoined             | New peer (PeerJoinedEventArgs)                  |
| OnPeerLeft               | Peer left (PeerLeftEventArgs)                   |
| OnMediaAdded             | Peer started audio (MediaAddedEventArgs)        |
| OnMediaRemoved           | Peer stopped audio (MediaRemovedEventArgs)      |
| OnMessageReceived        | Data received (MessageReceivedEventArgs)        |
| OnConnectionStateChanged | Status changes                                  |

### OdinMicrophoneReader Component

| Property                | Description                                |
|-------------------------|--------------------------------------------|
| RedirectCapturedAudio   | Auto-send to servers (default: true)       |
| SilenceCapturedAudio    | Mute outgoing (default: false)             |
| AutostartListen         | Start on component Start()                 |
| InputDevice             | Specific device name                       |
| MicVolumeScale          | Volume multiplier                          |

### Quick Start (High-Level)

#### Security Note

> **CRITICAL**: Only embed access keys in client code for testing purposes, **NEVER** in production code. Generate room tokens on a server for production deployments.

```csharp
using OdinNative.Unity;
using OdinNative.Unity.Audio;

public class OdinVoiceController : MonoBehaviour
{
    public string AccessKey;
    public string RoomName;
    
    private OdinRoom _room;

    void Start()
    {
        // Get or create OdinRoom component
        _room = GetComponent<OdinRoom>();
        
        // Register event handlers BEFORE joining
        _room.OnRoomJoined.AddListener(OnRoomJoined);
        _room.OnPeerJoined.AddListener(OnPeerJoined);
        _room.OnPeerLeft.AddListener(OnPeerLeft);
        _room.OnMediaAdded.AddListener(OnMediaAdded);
        _room.OnMediaRemoved.AddListener(OnMediaRemoved);
        
        // Setup microphone input
        var mic = GetComponentInChildren<OdinMicrophoneReader>();
        mic.OnAudioData.AddListener(_room.ProxyAudio);
        
        // Set token to join room (generate on backend in production!)
        _room.Token = OdinRoom.GenerateTestToken(RoomName, "Username", 5, AccessKey);
    }

    private void OnRoomJoined(object sender, RoomJoinedEventArgs args)
    {
        Debug.Log($"Joined room: {(args.Room as Room).Name}");
        
        // Create encoder for microphone input
        OdinRoom room = sender as OdinRoom;
        var mic = GetComponentInChildren<OdinMicrophoneReader>();
        
        if (room.LinkInputMedia((uint)mic.MicrophoneSamplerate, mic.MicrophoneChannels > 1, out MediaEncoder encoder))
        {
            // Optionally add effects to encoder pipeline
            OdinVadComponent vad = mic.gameObject.GetComponent<OdinVadComponent>();
            if (vad != null)
                vad.Media = encoder;
        }
    }

    private void OnPeerJoined(object sender, PeerJoinedEventArgs args)
    {
        Debug.Log($"Peer joined: {args.PeerId}");
    }

    private void OnPeerLeft(object sender, PeerLeftEventArgs args)
    {
        Debug.Log($"Peer left: {args.PeerId}");
    }

    private void OnMediaAdded(object sender, MediaAddedEventArgs args)
    {
        Debug.Log($"Media added: peer {args.PeerId}, media {args.MediaId}");
    }

    private void OnMediaRemoved(object sender, MediaRemovedEventArgs args)
    {
        Debug.Log($"Media removed: peer {args.PeerId}, media {args.MediaId}");
    }
}
```

### 2D Voice Chat (Non-Spatial)

With the OdinRoom prefab, 2D voice works with minimal setup:

```csharp
// The prefab handles everything automatically
// Just set the token to join
_room.Token = OdinRoom.GenerateTestToken(roomName, username, 5, accessKey);

// OdinPeer and OdinMedia GameObjects are created automatically
// Audio plays at same volume for everyone (spatialBlend = 0)
```

### 3D Voice Chat (Spatial)

For 3D spatial audio, create and configure peers/media in event handlers:

```csharp
using OdinNative.Unity;
using OdinNative.Unity.Audio;
using System.Collections.Concurrent;
using UnityEngine;

public class Odin3DSpatialExample : MonoBehaviour
{
    public string AccessKey;
    public string RoomName;
    public GameObject PeerPrefab;
    
    private OdinRoom _room;
    private ConcurrentDictionary<ulong, GameObject> _peers = new ConcurrentDictionary<ulong, GameObject>();
    private uint _sampleRate;
    private bool _isStereo;

    void Awake()
    {
        // Get Unity audio settings for decoder configuration
        _sampleRate = AudioSettings.outputSampleRate == 0 ? 48000 : (uint)AudioSettings.outputSampleRate;
        _isStereo = AudioSettings.speakerMode >= AudioSpeakerMode.Stereo;
    }

    void Start()
    {
        _room = GetComponent<OdinRoom>();
        
        _room.OnRoomJoined.AddListener(OnRoomJoined);
        _room.OnPeerJoined.AddListener(OnPeerJoined);
        _room.OnPeerLeft.AddListener(OnPeerLeft);
        _room.OnMediaAdded.AddListener(OnMediaAdded);
        _room.OnMediaRemoved.AddListener(OnMediaRemoved);
        
        // Setup microphone
        var mic = GetComponentInChildren<OdinMicrophoneReader>();
        mic.OnAudioData.AddListener(_room.ProxyAudio);
        
        _room.Token = OdinRoom.GenerateTestToken(RoomName, "Player", 5, AccessKey);
    }

    private void OnRoomJoined(object sender, RoomJoinedEventArgs args)
    {
        OdinRoom room = sender as OdinRoom;
        var mic = GetComponentInChildren<OdinMicrophoneReader>();
        
        if (room.LinkInputMedia((uint)mic.MicrophoneSamplerate, mic.MicrophoneChannels > 1, out MediaEncoder encoder))
        {
            // Add VAD if component exists
            OdinVadComponent vad = mic.gameObject.GetComponent<OdinVadComponent>();
            if (vad != null)
                vad.Media = encoder;
        }
    }

    private void OnPeerJoined(object sender, PeerJoinedEventArgs args)
    {
        OdinRoom room = sender as OdinRoom;
        
        // Create peer GameObject
        var peerContainer = Instantiate(PeerPrefab, new Vector3(0, 0.5f, 6), Quaternion.identity);
        
        // Add OdinPeer component and register with room
        room.AddPeerComponent(peerContainer, args.PeerId);
        
        _peers.TryAdd(args.PeerId, peerContainer);
    }

    private void OnPeerLeft(object sender, PeerLeftEventArgs args)
    {
        if (_peers.TryRemove(args.PeerId, out var peerContainer))
        {
            Destroy(peerContainer);
        }
    }

    private void OnMediaAdded(object sender, MediaAddedEventArgs args)
    {
        if (_peers.TryGetValue(args.PeerId, out var peerContainer))
        {
            var peer = peerContainer.GetComponent<OdinPeer>();
            
            // Create media GameObject as child of peer
            GameObject mediaObject = new GameObject(args.MediaId.ToString());
            mediaObject.transform.parent = peerContainer.transform;
            
            // Add media component with 3D spatial settings
            // Create disabled first to configure before enabling
            var media = peer.AddMediaComponent(mediaObject, args.MediaId, _sampleRate, _isStereo, enable: false);
            
            // Configure 3D spatial audio
            media.SpatialBlend = 1.0f;           // Full 3D
            media.RolloffMode = AudioRolloffMode.Linear;
            media.MaxDistance = 10.0f;
            media.MinDistance = 1.0f;
            
            // Enable after configuration
            media.enabled = true;
        }
    }

    private void OnMediaRemoved(object sender, MediaRemovedEventArgs args)
    {
        if (_peers.TryGetValue(args.PeerId, out var peerContainer))
        {
            var peer = peerContainer.GetComponent<OdinPeer>();
            if (peer != null)
            {
                // Let peer handle media removal
                peer.OnMediaRemoved.Invoke(sender, args);
            }
        }
    }

    void OnDestroy()
    {
        foreach (var obj in _peers.Values)
            Destroy(obj);
        _peers.Clear();
    }
}
```

### Key Methods

| Method | Description |
|--------|-------------|
| `OdinRoom.AddPeerComponent(gameObject, peerId)` | Attach OdinPeer to a GameObject |
| `OdinPeer.AddMediaComponent(gameObject, mediaId, sampleRate, stereo, enable)` | Create OdinMedia for playback |
| `OdinRoom.LinkInputMedia(sampleRate, stereo, out encoder)` | Create encoder for microphone |
| `OdinMicrophoneReader.OnAudioData` | Event for audio data - connect to `room.ProxyAudio` |

## Audio Pipeline Effects

Add effects to encoder pipelines:

```csharp
private void OnRoomJoined(object sender, RoomJoinedEventArgs args)
{
    OdinRoom room = sender as OdinRoom;
    var mic = GetComponentInChildren<OdinMicrophoneReader>();
    
    if (room.LinkInputMedia((uint)mic.MicrophoneSamplerate, mic.MicrophoneChannels > 1, out MediaEncoder encoder))
    {
        // Add VAD component (if exists on microphone GameObject)
        OdinVadComponent vad = mic.gameObject.GetComponent<OdinVadComponent>();
        if (vad != null)
            vad.Media = encoder;
        
        // Add volume boost component
        OdinVolumeBoostComponent volumeBoost = mic.gameObject.GetComponent<OdinVolumeBoostComponent>();
        if (volumeBoost != null)
            volumeBoost.Media = encoder;
    }
}
```

For playback effects on OdinMedia:

```csharp
private void OnMediaAdded(object sender, MediaAddedEventArgs args)
{
    // ... after creating media ...
    
    // Add VAD to decoder for voice activity detection
    media.AddVad();
    
    // Listen for voice activity changes
    media.OnActiveStateChanged.AddListener(OnMediaActivityChanged);
}

private void OnMediaActivityChanged(object sender, MediaActiveStateChangedEventArgs args)
{
    Debug.Log($"Media {args.MediaId} active: {args.Active}");
}
```

### Available Effect Components

| Component               | Target  | Description                    |
|-------------------------|---------|--------------------------------|
| OdinVadComponent        | Encoder | Voice Activity Detection       |
| OdinVolumeBoostComponent| Both    | Volume enhancement             |
| OdinMuteAudioComponent  | Both    | Mute control                   |

## Multi-Room Setup

V2.x enables multiple concurrent rooms:

```csharp
public OdinRoom teamChat;   // 2D team communication
public OdinRoom worldVoice; // 3D proximity voice

void Start()
{
    teamChat.OnPeerJoined.AddListener(Handle2DPeer);
    worldVoice.OnPeerJoined.AddListener(Handle3DPeer);

    teamChat.Token = GetTeamToken();
    worldVoice.Token = GetWorldToken();
}

private void Handle2DPeer(object sender, PeerJoinedEventArgs args)
{
    // Default handling - 2D audio
}

private void Handle3DPeer(object sender, PeerJoinedEventArgs args)
{
    // Create peer container and attach to player for 3D
    OdinRoom room = sender as OdinRoom;
    var container = new GameObject($"Peer_{args.PeerId}");
    room.AddPeerComponent(container, args.PeerId);
}
```

## Common Patterns

### User Data for Player Mapping

```csharp
// Custom user data class
public class UserData
{
    public string name;
    public string id;
}

// When peer joins - extract their user data
private void OnPeerJoined(object sender, PeerJoinedEventArgs args)
{
    OdinRoom room = sender as OdinRoom;
    var roomApi = room.GetBaseRoom<Room>();
    var peerData = roomApi.RemotePeers[args.PeerId]?.UserData;
    
    // Parse user data (depends on your serialization format)
    var userData = JsonUtility.FromJson<UserData>(System.Text.Encoding.UTF8.GetString(peerData));
    Debug.Log($"Peer {userData.name} joined");
}
```

### Push-to-Talk

```csharp
OdinMicrophoneReader microphoneReader;

void Update()
{
    if (Input.GetKeyDown(KeyCode.V))
        microphoneReader.SilenceCapturedAudio = false;
    if (Input.GetKeyUp(KeyCode.V))
        microphoneReader.SilenceCapturedAudio = true;
}
```

### Leaving a Room

```csharp
public void LeaveRoom()
{
    // Remove microphone listener
    var mic = GetComponent<OdinMicrophoneReader>();
    if (mic != null)
        mic.OnAudioData.RemoveListener(_room.ProxyAudio);
    
    // Destroy room - this leaves the room
    Destroy(_room);
}
```

## Available Samples

Import from Package Manager:

| Sample              | Description                               |
|---------------------|-------------------------------------------|
| InstanceSample2D    | Conferencing-style non-spatial voice      |
| InstanceSample3D    | Spatial voice with positioning            |
| InstanceSampleBasic | Minimal low-level API example             |

## Migration from v1.x

**Key Changes**:
1. Replace `OdinHandler.Instance` calls with `OdinRoom` component references
2. Update event listeners: `OnCreatedMediaObject` → `OnMediaAdded`
3. Replace `AddPlaybackComponent()` with `OdinPeer.AddMediaComponent()`
4. Set `Token` property instead of calling `JoinRoom()`
5. Use `mic.OnAudioData.AddListener(room.ProxyAudio)` for microphone
6. Update Unity version to 2021.4+ if needed

**When to migrate**: Only migrate if you need multi-room support or new 2.x features. Version 1.x remains stable and supported.

## Troubleshooting

See [references/troubleshooting.md](../references/troubleshooting.md) for common issues.

### v2.x Specific Issues

**No Audio Output**
- Ensure `OdinMedia.enabled = true` after configuration
- Verify decoder sample rate matches Unity's `AudioSettings.outputSampleRate`
- Check `media.SpatialBlend` setting (0 = 2D, 1 = 3D)

**Microphone Not Captured**
- Verify `OdinMicrophoneReader` is in scene
- Check `mic.OnAudioData.AddListener(_room.ProxyAudio)` is called
- Ensure `LinkInputMedia()` returns true

## Documentation Links

- Manual: https://docs.4players.io/voice/unity/next/manual/
- API Reference: https://docs.4players.io/voice/unity/next/api/
